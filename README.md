# 16s-nf

Prepare a report for taxonomic assignment based on [16S rRNA](https://en.wikipedia.org/wiki/16S_ribosomal_RNA) sequences, using [BLAST](https://blast.ncbi.nlm.nih.gov/Blast.cgi).

## Setup

### BLASTN Databases 

The pipeline requires a list of BLAST databases to run against. It should follow the following format:

```csv
ID,DBNAME,DBVERSION,PATH
ncbi,16s-ncbi,1.0,/path/to/blastn/database/2023-12-12_1.0_16s-ncbi
db2,database2,1.0,/path/to/blastn/database/2023-12-20_1.0_16s-db2
db3,database3,1.0,/path/to/blastn/database/2024-01-15_1.0_16s-db3
```

...where we expect to find the actual database files at:

```
/path/to/blastn/database/2023-12-12_1.0_16s-ncbi/16s-ncbi.ndb
/path/to/blastn/database/2023-12-12_1.0_16s-ncbi/16s-ncbi.nhr
/path/to/blastn/database/2023-12-12_1.0_16s-ncbi/16s-ncbi.nin
...etc

/path/to/blastn/database/2023-12-20_1.0_16s-db2/database2.ndb
/path/to/blastn/database/2023-12-20_1.0_16s-db2/database2.nhr
/path/to/blastn/database/2023-12-20_1.0_16s-db2/database2.nin
...etc
```

The pipeline also assumes that there is a `metadata.json` file alongside the database files

```
/path/to/ncbi/2023-09-19_1.1_16S_ribosomal_RNA/metadata.json
/path/to/silva/2020-08-24_138.1_SSURef_NR99_tax_silva_trunc/metadata.json
```

The contents of the metadata file may vary by database, but we assume that:

- The file contains a single top-level object (not an array or atomic value).
- The top-level object should at minimum, include these fields:

```
version
date
```

The values associated with those fields will be incorporated into the blast results. All other fields in
the `metadata.json` file are ignored.
An example `metadata.json` is as follows:
```
{
  "dbname": "16s-ncbi",
  "version": "1.0",
  "date": "2024-01-16",
  "number-of-sequences": 27056,
}
```

### Taxonkit
It is also required to provide a path to a local copy of the `taxonkit` database.
Download and installation instructions can be found [here](https://bioinf.shenwei.me/taxonkit/#dataset)


## Running The Pipeline

The following command will run the pipeline using Nextflow:

```
nextflow run BCCDC-PHL/16s-nf \
  --databases </path/to/blast/databases.csv> \
  --fasta_input </path/to/fasta_dir> \
  --outdir </path/to/output_dir>
  --taxonkit_db </path/to/taxonkit/database>
```

By default, minimum identity and coverage thresholds of 95% will be applied to the blast results.
Alternate thresholds can be applied using the `--minid` and `--mincov` flags.

```
nextflow run BCCDC-PHL/16s-nf \
  --databases </path/to/blast/databases.csv> \
  --fasta_input </path/to/fasta_dir> \
  --minid 99.0 \
  --mincov 97.5 \
  --outdir </path/to/output_dir>
  --taxonkit_db </path/to/taxonkit/database>
```

Collecting database metadata from the `metadata.json` file can be skipped using the `--no_db_metadata` flag.

```
nextflow run BCCDC-PHL/16s-nf \
  --databases </path/to/blast/databases.csv> \
  --no_db_metadata \
  --fasta_input </path/to/fasta_dir> \
  --outdir </path/to/output_dir>
```


## Outputs

Each sequence will have a separate output directory, named using the seq ID parsed from
the fasta header. That directory will contain:

```
<seq_id>_<db_id>_blast.csv
<seq_id>_<db_id>_blast_best_bitscore.csv
<seq_id>_<db_id>_blast_filtered.csv
<seq_id>_<db_id>_lineages.tsv
<seq_id>_<db_id>_seq_qc.csv
```

The `_blast.csv`, `_blast_filtered.csv` and `blast_best_bitscore.csv` files have the following headers:

```
query_seq_id
subject_accession
subject_strand
query_length
query_start
query_end
subject_length
subject_start
subject_end
alignment_length
percent_identity
percent_coverage
num_mismatch
num_gaps
e_value
bitscore
subject_taxids
subject_names
genus
species
database_name
database_version
database_date
```

...though if the `--no_db_metadata` flag is used when running the pipeline, the last three fields will be omitted.

The `_blast_best_bitscore.csv` file will only include one entry per species per database if there are multiple matches from the same
species with equally-good bitscores.

The `_lineages.tsv` file is generated by `taxonkit`, and has the following headers:

```
query_taxid
lineage
lineage_taxids
query_taxon_name
lineage_ranks
```

...where the `lineage`, `lineage_taxids`, and `lineage_ranks` are themselves semicolon-separated lists.

The `seq_qc.csv` file has the following headers:

```
seq_length
num_ambiguous_bases
num_n_bases
```

There will also be collected ouputs in the top-level of the `--outdir` directory, named:

```
collected_blast.csv
collected_blast_best_bitscore.csv
```

...which will include results from all sequences.
